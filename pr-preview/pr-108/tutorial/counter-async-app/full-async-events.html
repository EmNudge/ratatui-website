<!DOCTYPE HTML>
<html lang="en" class="light" dir="">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Async Render - Ratatui Book</title>


        <!-- Custom HTML head -->
        <script type="module">
          import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
          mermaid.initialize({ startOnLoad: true });
        </script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././mdbook-admonish.css">
        <link rel="stylesheet" href="../.././theme/catppuccin.css">
        <link rel="stylesheet" href="../.././theme/catppuccin-highlight.css">
        <link rel="stylesheet" href="../.././theme/catppuccin-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction to Ratatui</a></li><li class="chapter-item expanded "><a href="../../installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../../tutorial/index.html"><strong aria-hidden="true">2.</strong> Tutorials</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/hello-world/index.html"><strong aria-hidden="true">2.1.</strong> Hello World</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/index.html"><strong aria-hidden="true">2.2.</strong> Counter App</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-app/single-function.html"><strong aria-hidden="true">2.2.1.</strong> Single Function</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/multiple-functions.html"><strong aria-hidden="true">2.2.2.</strong> Multiple Functions</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/multiple-files.html"><strong aria-hidden="true">2.2.3.</strong> Multiple Files</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-app/app.html"><strong aria-hidden="true">2.2.3.1.</strong> app.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/ui.html"><strong aria-hidden="true">2.2.3.2.</strong> ui.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/event.html"><strong aria-hidden="true">2.2.3.3.</strong> event.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/tui.html"><strong aria-hidden="true">2.2.3.4.</strong> tui.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/update.html"><strong aria-hidden="true">2.2.3.5.</strong> update.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/main.html"><strong aria-hidden="true">2.2.3.6.</strong> main.rs</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../tutorial/json-editor/index.html"><strong aria-hidden="true">2.3.</strong> JSON Editor</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/json-editor/app.html"><strong aria-hidden="true">2.3.1.</strong> App.rs - Holding application state</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/main.html"><strong aria-hidden="true">2.3.2.</strong> Main.rs - UI loop and event handling</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui.html"><strong aria-hidden="true">2.3.3.</strong> Ui.rs - Layouts, widgets, frames, oh my!</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/json-editor/ui-main.html"><strong aria-hidden="true">2.3.3.1.</strong> Ui.rs - Main</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui-editing.html"><strong aria-hidden="true">2.3.3.2.</strong> Ui.rs - Editing</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui-exit.html"><strong aria-hidden="true">2.3.3.3.</strong> Ui.rs - Exit</a></li></ol></li><li class="chapter-item "><a href="../../tutorial/json-editor/closing_thoughts.html"><strong aria-hidden="true">2.3.4.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="../../tutorial/counter-async-app/index.html"><strong aria-hidden="true">2.4.</strong> Async Counter App</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-async-app/async-event-stream.html"><strong aria-hidden="true">2.4.1.</strong> Async KeyEvents</a></li><li class="chapter-item expanded "><a href="../../tutorial/counter-async-app/full-async-events.html" class="active"><strong aria-hidden="true">2.4.2.</strong> Async Render</a></li><li class="chapter-item "><a href="../../tutorial/counter-async-app/actions.html"><strong aria-hidden="true">2.4.3.</strong> Introducing Actions</a></li><li class="chapter-item "><a href="../../tutorial/counter-async-app/full-async-actions.html"><strong aria-hidden="true">2.4.4.</strong> Async Actions</a></li><li class="chapter-item "><a href="../../tutorial/counter-async-app/conclusion.html"><strong aria-hidden="true">2.4.5.</strong> Conclusion</a></li></ol></li><li class="chapter-item "><a href="../../tutorial/stopwatch-app/index.html"><strong aria-hidden="true">2.5.</strong> Stopwatch App</a></li></ol></li><li class="chapter-item expanded "><a href="../../concepts/index.html"><strong aria-hidden="true">3.</strong> Concepts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../concepts/rendering.html"><strong aria-hidden="true">3.1.</strong> Rendering</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../concepts/rendering-under-the-hood.html"><strong aria-hidden="true">3.1.1.</strong> Under the hood</a></li></ol></li><li class="chapter-item "><a href="../../concepts/layout/index.html"><strong aria-hidden="true">3.2.</strong> Layout</a></li><li class="chapter-item "><a href="../../concepts/application-patterns/index.html"><strong aria-hidden="true">3.3.</strong> Application Patterns</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../concepts/application-patterns/the-elm-architecture.html"><strong aria-hidden="true">3.3.1.</strong> The Elm Architecture</a></li><li class="chapter-item "><a href="../../concepts/application-patterns/component-architecture.html"><strong aria-hidden="true">3.3.2.</strong> Component Architecture</a></li><li class="chapter-item "><a href="../../concepts/application-patterns/flux-architecture.html"><strong aria-hidden="true">3.3.3.</strong> Flux Architecture</a></li></ol></li><li class="chapter-item "><a href="../../concepts/backends/index.html"><strong aria-hidden="true">3.4.</strong> Backends</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../concepts/backends/comparison.html"><strong aria-hidden="true">3.4.1.</strong> Comparison</a></li><li class="chapter-item "><a href="../../concepts/backends/raw-mode.html"><strong aria-hidden="true">3.4.2.</strong> Raw Mode</a></li><li class="chapter-item "><a href="../../concepts/backends/alternate-screen.html"><strong aria-hidden="true">3.4.3.</strong> Alternate Screen</a></li><li class="chapter-item "><a href="../../concepts/backends/mouse-capture.html"><strong aria-hidden="true">3.4.4.</strong> Mouse Capture</a></li></ol></li><li class="chapter-item "><a href="../../concepts/event_handling.html"><strong aria-hidden="true">3.5.</strong> Event Handling</a></li></ol></li><li class="chapter-item expanded "><a href="../../how-to/index.html"><strong aria-hidden="true">4.</strong> How To</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/layout/index.html"><strong aria-hidden="true">4.1.</strong> Layout UIs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/layout/dynamic.html"><strong aria-hidden="true">4.1.1.</strong> Dynamic Layouts</a></li><li class="chapter-item "><a href="../../how-to/layout/center-a-rect.html"><strong aria-hidden="true">4.1.2.</strong> Center a Rect</a></li></ol></li><li class="chapter-item "><a href="../../how-to/render/index.html"><strong aria-hidden="true">4.2.</strong> Render Text</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/render/display-text.html"><strong aria-hidden="true">4.2.1.</strong> Display Text</a></li><li class="chapter-item "><a href="../../how-to/render/style-text.html"><strong aria-hidden="true">4.2.2.</strong> Style Text</a></li></ol></li><li class="chapter-item "><a href="../../how-to/widgets/index.html"><strong aria-hidden="true">4.3.</strong> Use Widgets</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/widgets/paragraph.html"><strong aria-hidden="true">4.3.1.</strong> Paragraph</a></li><li class="chapter-item "><a href="../../how-to/widgets/block.html"><strong aria-hidden="true">4.3.2.</strong> Block</a></li><li class="chapter-item "><a href="../../how-to/widgets/custom.html"><strong aria-hidden="true">4.3.3.</strong> Custom</a></li></ol></li><li class="chapter-item "><a href="../../how-to/develop-apps/index.html"><strong aria-hidden="true">4.4.</strong> Develop Applications</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/develop-apps/cli-arguments.html"><strong aria-hidden="true">4.4.1.</strong> CLI arguments</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/config-directories.html"><strong aria-hidden="true">4.4.2.</strong> Configuration Directories</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/tracing.html"><strong aria-hidden="true">4.4.3.</strong> Logging with Tracing</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/abstract-terminal-and-event-handler.html"><strong aria-hidden="true">4.4.4.</strong> Async Terminal and Event handler</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/setup-panic-hooks.html"><strong aria-hidden="true">4.4.5.</strong> Setup Panic Hooks</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/better-panic-hooks.html"><strong aria-hidden="true">4.4.6.</strong> Better Panic Hooks</a></li><li class="chapter-item "><a href="../../how-to/develop-apps/migrate-from-tui-rs.html"><strong aria-hidden="true">4.4.7.</strong> Migrate from tui-rs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../faq/index.html"><strong aria-hidden="true">5.</strong> FAQ</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../faq/duplicate-key-events-windows.html"><strong aria-hidden="true">5.1.</strong> Duplicate key events</a></li><li class="chapter-item "><a href="../../faq/tokio-async.html"><strong aria-hidden="true">5.2.</strong> tokio / async</a></li><li class="chapter-item "><a href="../../faq/tui-rs-history.html"><strong aria-hidden="true">5.3.</strong> tui.rs history</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Highlights</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../highlights/v0.23.html"><strong aria-hidden="true">6.1.</strong> v0.23</a></li><li class="chapter-item "><a href="../../highlights/v0.22.html"><strong aria-hidden="true">6.2.</strong> v0.22</a></li><li class="chapter-item "><a href="../../highlights/v0.21.html"><strong aria-hidden="true">6.3.</strong> v0.21</a></li></ol></li><li class="chapter-item expanded "><a href="../../references/index.html"><strong aria-hidden="true">7.</strong> References</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../showcase/index.html"><strong aria-hidden="true">7.1.</strong> Showcase</a></li><li class="chapter-item "><a href="../../references/features.html"><strong aria-hidden="true">7.2.</strong> Features</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Developer Guide</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../developer-guide/ratatui.html"><strong aria-hidden="true">8.1.</strong> Ratatui</a></li><li class="chapter-item "><a href="../../developer-guide/book.html"><strong aria-hidden="true">8.2.</strong> Ratatui Book</a></li><li class="chapter-item "><a href="../../LICENSE.html"><strong aria-hidden="true">8.3.</strong> License</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ratatui Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/ratatui-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/ratatui-book/edit/main/src/tutorial/counter-async-app/full-async-events.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="full-async---events"><a class="header" href="#full-async---events">Full Async - <code>Event</code>s</a></h1>
<p>There are a number of ways to make our application work more in an <code>async</code> manner. The easiest way
to do this is to add more <code>Event</code> variants to our existing <code>EventHandler</code>. Specifically, we would
like to only render in the main run loop when we receive a <code>Event::Render</code> variant:</p>
<pre><code class="language-rust">#[derive(Clone, Debug, Serialize, Deserialize)]
pub enum Event {
  Quit,
  Error,
  Tick,
  Render, // new
  Key(KeyEvent),
}</code></pre>
<p>Another thing I personally like to do is combine the <code>EventHandler</code> struct and the <code>Terminal</code>
functionality. To do this, we are going to rename our <code>EventHandler</code> struct to a <code>Tui</code> struct. We
are also going to include a few more <code>Event</code> variants for making our application more capable.</p>
<p>Below is the relevant snippet of an updated <code>Tui</code> struct. You can click on the “Show hidden lines”
button at the top right of the code block or check out
<a href="../../how-to/develop-apps/abstract-terminal-and-event-handler.html">this section of the book</a> for the
full version this struct.</p>
<p>The key things to note are that we create a <code>tick_interval</code>, <code>render_interval</code> and <code>reader</code> stream
that can be polled using <code>tokio::select!</code>. This means that even while waiting for a key press, we
will still send a <code>Event::Tick</code> and <code>Event::Render</code> at regular intervals.</p>
<pre><code class="language-rust"><span class="boring">use std::{
</span><span class="boring">  ops::{Deref, DerefMut},
</span><span class="boring">  time::Duration,
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">use color_eyre::eyre::Result;
</span><span class="boring">use crossterm::{
</span><span class="boring">  cursor,
</span><span class="boring">  event::{
</span><span class="boring">    DisableBracketedPaste, DisableMouseCapture, EnableBracketedPaste, EnableMouseCapture, Event as CrosstermEvent,
</span><span class="boring">    KeyEvent, KeyEventKind, MouseEvent,
</span><span class="boring">  },
</span><span class="boring">  terminal::{EnterAlternateScreen, LeaveAlternateScreen},
</span><span class="boring">};
</span><span class="boring">use futures::{FutureExt, StreamExt};
</span><span class="boring">use ratatui::backend::CrosstermBackend as Backend;
</span><span class="boring">use tokio::{
</span><span class="boring">  sync::mpsc::{self, UnboundedReceiver, UnboundedSender},
</span><span class="boring">  task::JoinHandle,
</span><span class="boring">};
</span><span class="boring">use tokio_util::sync::CancellationToken;
</span><span class="boring">
</span><span class="boring">pub type Frame&lt;'a&gt; = ratatui::Frame&lt;'a, Backend&lt;std::io::Stderr&gt;&gt;;
</span><span class="boring">
</span>#[derive(Clone, Debug)]
pub enum Event {
  Init,
  Quit,
  Error,
  Closed,
  Tick,
  Render,
  FocusGained,
  FocusLost,
  Paste(String),
  Key(KeyEvent),
  Mouse(MouseEvent),
  Resize(u16, u16),
}

pub struct Tui {
  pub terminal: ratatui::Terminal&lt;Backend&lt;std::io::Stderr&gt;&gt;,
  pub task: JoinHandle&lt;()&gt;,
<span class="boring">  pub cancellation_token: CancellationToken,
</span>  pub event_rx: UnboundedReceiver&lt;Event&gt;,
  pub event_tx: UnboundedSender&lt;Event&gt;,
  pub frame_rate: f64,
  pub tick_rate: f64,
<span class="boring">  pub mouse: bool,
</span><span class="boring">  pub paste: bool,
</span>}

impl Tui {
<span class="boring">  pub fn new() -&gt; Result&lt;Self&gt; {
</span><span class="boring">    let tick_rate = 4.0;
</span><span class="boring">    let frame_rate = 60.0;
</span><span class="boring">    let terminal = ratatui::Terminal::new(Backend::new(std::io::stderr()))?;
</span><span class="boring">    let (event_tx, event_rx) = mpsc::unbounded_channel();
</span><span class="boring">    let cancellation_token = CancellationToken::new();
</span><span class="boring">    let task = tokio::spawn(async {});
</span><span class="boring">    let mouse = false;
</span><span class="boring">    let paste = false;
</span><span class="boring">    Ok(Self { terminal, task, cancellation_token, event_rx, event_tx, frame_rate, tick_rate, mouse, paste })
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn tick_rate(mut self, tick_rate: f64) -&gt; Self {
</span><span class="boring">    self.tick_rate = tick_rate;
</span><span class="boring">    self
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn frame_rate(mut self, frame_rate: f64) -&gt; Self {
</span><span class="boring">    self.frame_rate = frame_rate;
</span><span class="boring">    self
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn mouse(mut self, mouse: bool) -&gt; Self {
</span><span class="boring">    self.mouse = mouse;
</span><span class="boring">    self
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn paste(mut self, paste: bool) -&gt; Self {
</span><span class="boring">    self.paste = paste;
</span><span class="boring">    self
</span><span class="boring">  }
</span><span class="boring">
</span>  pub fn start(&amp;mut self) {
    let tick_delay = std::time::Duration::from_secs_f64(1.0 / self.tick_rate);
    let render_delay = std::time::Duration::from_secs_f64(1.0 / self.frame_rate);
<span class="boring">    self.cancel();
</span><span class="boring">    self.cancellation_token = CancellationToken::new();
</span><span class="boring">    let _cancellation_token = self.cancellation_token.clone();
</span>    let _event_tx = self.event_tx.clone();
    self.task = tokio::spawn(async move {
      let mut reader = crossterm::event::EventStream::new();
      let mut tick_interval = tokio::time::interval(tick_delay);
      let mut render_interval = tokio::time::interval(render_delay);
<span class="boring">      _event_tx.send(Event::Init).unwrap();
</span>      loop {
        let tick_delay = tick_interval.tick();
        let render_delay = render_interval.tick();
        let crossterm_event = reader.next().fuse();
        tokio::select! {
<span class="boring">          _ = _cancellation_token.cancelled() =&gt; {
</span><span class="boring">            break;
</span><span class="boring">          }
</span>          maybe_event = crossterm_event =&gt; {
            match maybe_event {
              Some(Ok(evt)) =&gt; {
                match evt {
                  CrosstermEvent::Key(key) =&gt; {
                    if key.kind == KeyEventKind::Press {
                      _event_tx.send(Event::Key(key)).unwrap();
                    }
                  },
<span class="boring">                  CrosstermEvent::Mouse(mouse) =&gt; {
</span><span class="boring">                    _event_tx.send(Event::Mouse(mouse)).unwrap();
</span><span class="boring">                  },
</span><span class="boring">                  CrosstermEvent::Resize(x, y) =&gt; {
</span><span class="boring">                    _event_tx.send(Event::Resize(x, y)).unwrap();
</span><span class="boring">                  },
</span><span class="boring">                  CrosstermEvent::FocusLost =&gt; {
</span><span class="boring">                    _event_tx.send(Event::FocusLost).unwrap();
</span><span class="boring">                  },
</span><span class="boring">                  CrosstermEvent::FocusGained =&gt; {
</span><span class="boring">                    _event_tx.send(Event::FocusGained).unwrap();
</span><span class="boring">                  },
</span><span class="boring">                  CrosstermEvent::Paste(s) =&gt; {
</span><span class="boring">                    _event_tx.send(Event::Paste(s)).unwrap();
</span><span class="boring">                  },
</span>                }
              }
              Some(Err(_)) =&gt; {
                _event_tx.send(Event::Error).unwrap();
              }
              None =&gt; {},
            }
          },
          _ = tick_delay =&gt; {
              _event_tx.send(Event::Tick).unwrap();
          },
          _ = render_delay =&gt; {
              _event_tx.send(Event::Render).unwrap();
          },
        }
      }
    });
  }
<span class="boring">
</span><span class="boring">  pub fn enter(&amp;mut self) -&gt; Result&lt;()&gt; {
</span><span class="boring">    crossterm::terminal::enable_raw_mode()?;
</span><span class="boring">    crossterm::execute!(std::io::stderr(), EnterAlternateScreen, cursor::Hide)?;
</span><span class="boring">    if self.mouse {
</span><span class="boring">      crossterm::execute!(std::io::stderr(), EnableMouseCapture)?;
</span><span class="boring">    }
</span><span class="boring">    if self.paste {
</span><span class="boring">      crossterm::execute!(std::io::stderr(), EnableBracketedPaste)?;
</span><span class="boring">    }
</span><span class="boring">    self.start();
</span><span class="boring">    Ok(())
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn exit(&amp;mut self) -&gt; Result&lt;()&gt; {
</span><span class="boring">    self.stop()?;
</span><span class="boring">    if crossterm::terminal::is_raw_mode_enabled()? {
</span><span class="boring">      self.flush()?;
</span><span class="boring">      if self.paste {
</span><span class="boring">        crossterm::execute!(std::io::stderr(), DisableBracketedPaste)?;
</span><span class="boring">      }
</span><span class="boring">      if self.mouse {
</span><span class="boring">        crossterm::execute!(std::io::stderr(), DisableMouseCapture)?;
</span><span class="boring">      }
</span><span class="boring">      crossterm::execute!(std::io::stderr(), LeaveAlternateScreen, cursor::Show)?;
</span><span class="boring">      crossterm::terminal::disable_raw_mode()?;
</span><span class="boring">    }
</span><span class="boring">    Ok(())
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn cancel(&amp;self) {
</span><span class="boring">    self.cancellation_token.cancel();
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub fn resume(&amp;mut self) -&gt; Result&lt;()&gt; {
</span><span class="boring">    self.enter()?;
</span><span class="boring">    Ok(())
</span><span class="boring">  }
</span><span class="boring">
</span><span class="boring">  pub async fn next(&amp;mut self) -&gt; Result&lt;Event&gt; {
</span><span class="boring">    self.event_rx.recv().await.ok_or(color_eyre::eyre::eyre!(&quot;Unable to get event&quot;))
</span><span class="boring">  }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Deref for Tui {
</span><span class="boring">  type Target = ratatui::Terminal&lt;Backend&lt;std::io::Stderr&gt;&gt;;
</span><span class="boring">
</span><span class="boring">  fn deref(&amp;self) -&gt; &amp;Self::Target {
</span><span class="boring">    &amp;self.terminal
</span><span class="boring">  }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl DerefMut for Tui {
</span><span class="boring">  fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
</span><span class="boring">    &amp;mut self.terminal
</span><span class="boring">  }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Drop for Tui {
</span><span class="boring">  fn drop(&amp;mut self) {
</span><span class="boring">    self.exit().unwrap();
</span><span class="boring">  }
</span><span class="boring">}</span></code></pre>
<p>We made a number of changes to the <code>Tui</code> struct.</p>
<ol>
<li>We added a <code>Deref</code> and <code>DerefMut</code> so we can call <code>tui.draw(|f| ...)</code> to have it call
<code>tui.terminal.draw(|f| ...)</code>.</li>
<li>We moved the <code>startup()</code> and <code>shutdown()</code> functionality into the <code>Tui</code> struct.</li>
<li>We also added a <code>CancellationToken</code> so that we can start and stop the tokio task more easily.</li>
<li>We added <code>Event</code> variants for <code>Resize</code>, <code>Focus</code>, and <code>Paste</code>.</li>
<li>We added methods to set the <code>tick_rate</code>, <code>frame_rate</code>, and whether we want to enable <code>mouse</code> or
<code>paste</code> events.</li>
</ol>
<p>Here’s the code for the fully async application:</p>
<pre><code class="language-rust">mod tui;

use color_eyre::eyre::Result;
use crossterm::event::KeyCode::Char;
use ratatui::{prelude::CrosstermBackend, widgets::Paragraph};
use tui::Event;

pub type Frame&lt;'a&gt; = ratatui::Frame&lt;'a, CrosstermBackend&lt;std::io::Stderr&gt;&gt;;

// App state
struct App {
  counter: i64,
  should_quit: bool,
}

// App ui render function
fn ui(f: &amp;mut Frame&lt;'_&gt;, app: &amp;App) {
  f.render_widget(Paragraph::new(format!(&quot;Counter: {}&quot;, app.counter)), f.size());
}

fn update(app: &amp;mut App, event: Event) {
  match event {
    Event::Key(key) =&gt; {
      match key.code {
        Char('j') =&gt; app.counter += 1,
        Char('k') =&gt; app.counter -= 1,
        Char('q') =&gt; app.should_quit = true,
        _ =&gt; Action::None,
      }
    },
    _ =&gt; {},
  };
}

async fn run() -&gt; Result&lt;()&gt; {
  // ratatui terminal
  let mut tui = tui::Tui::new()?.tick_rate(1.0).frame_rate(30.0);
  tui.enter()?;

  // application state
  let mut app = App { counter: 0, should_quit: false };

  loop {
    let event = tui.next().await?; // blocks until next event

    if let Event::Render = event.clone() {
      // application render
      tui.draw(|f| {
        ui(f, &amp;app);
      })?;
    }

    // application update
    update(&amp;mut app, event);

    // application exit
    if app.should_quit {
      break;
    }
  }
  tui.exit()?;

  Ok(())
}

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
  let result = run().await;

  result?;

  Ok(())
}</code></pre>
<p>The above code ensures that we render at a consistent frame rate. As an exercise, play around with
this frame rate and tick rate to see how the CPU utilization changes as you change those numbers.</p>
<p>Even though our application renders in an “async” manner, we also want to perform “actions” in an
asynchronous manner. We will improve this in the next section to make our application truly async
capable.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../tutorial/counter-async-app/async-event-stream.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../tutorial/counter-async-app/actions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../tutorial/counter-async-app/async-event-stream.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../tutorial/counter-async-app/actions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>