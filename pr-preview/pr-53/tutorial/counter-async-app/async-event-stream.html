<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Async Event Stream - Ratatui Book</title>


        <!-- Custom HTML head -->
        <script type="module">
          import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
          mermaid.initialize({ startOnLoad: true });
        </script>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././mdbook-admonish.css">
        <link rel="stylesheet" href="../.././theme/catppuccin.css">
        <link rel="stylesheet" href="../.././theme/catppuccin-highlight.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Home</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Tutorials</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/hello-world/index.html"><strong aria-hidden="true">2.1.</strong> Hello World</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/index.html"><strong aria-hidden="true">2.2.</strong> Counter App</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-app/single-function.html"><strong aria-hidden="true">2.2.1.</strong> Single Function</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/refactor.html"><strong aria-hidden="true">2.2.2.</strong> Multiple Functions</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/multiple-files.html"><strong aria-hidden="true">2.2.3.</strong> Multiple Files</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-app/app.html"><strong aria-hidden="true">2.2.3.1.</strong> app.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/ui.html"><strong aria-hidden="true">2.2.3.2.</strong> ui.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/event.html"><strong aria-hidden="true">2.2.3.3.</strong> event.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/tui.html"><strong aria-hidden="true">2.2.3.4.</strong> tui.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/update.html"><strong aria-hidden="true">2.2.3.5.</strong> update.rs</a></li><li class="chapter-item "><a href="../../tutorial/counter-app/main.html"><strong aria-hidden="true">2.2.3.6.</strong> main.rs</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../tutorial/json-editor/index.html"><strong aria-hidden="true">2.3.</strong> JSON Editor</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/json-editor/app.html"><strong aria-hidden="true">2.3.1.</strong> App.rs - Holding application state</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/main.html"><strong aria-hidden="true">2.3.2.</strong> Main.rs - UI loop and event handling</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui.html"><strong aria-hidden="true">2.3.3.</strong> Ui.rs - Layouts, widgets, frames, oh my!</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/json-editor/ui-main.html"><strong aria-hidden="true">2.3.3.1.</strong> Ui.rs - Main</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui-editing.html"><strong aria-hidden="true">2.3.3.2.</strong> Ui.rs - Editing</a></li><li class="chapter-item "><a href="../../tutorial/json-editor/ui-exit.html"><strong aria-hidden="true">2.3.3.3.</strong> Ui.rs - Exit</a></li></ol></li><li class="chapter-item "><a href="../../tutorial/json-editor/closing_thoughts.html"><strong aria-hidden="true">2.3.4.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="../../tutorial/counter-async-app/index.html"><strong aria-hidden="true">2.4.</strong> Async Counter App</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../tutorial/counter-async-app/actions.html"><strong aria-hidden="true">2.4.1.</strong> Actions</a></li><li class="chapter-item "><a href="../../tutorial/counter-async-app/sync-increment-decrement.html"><strong aria-hidden="true">2.4.2.</strong> Sync Increment & Decrement</a></li><li class="chapter-item "><a href="../../tutorial/counter-async-app/async-increment-decrement.html"><strong aria-hidden="true">2.4.3.</strong> Async Increment & Decrement</a></li><li class="chapter-item expanded "><a href="../../tutorial/counter-async-app/async-event-stream.html" class="active"><strong aria-hidden="true">2.4.4.</strong> Async Event Stream</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../concepts/index.html"><strong aria-hidden="true">3.</strong> Concepts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../concepts/rendering.html"><strong aria-hidden="true">3.1.</strong> Rendering</a></li><li class="chapter-item "><a href="../../concepts/event_handling.html"><strong aria-hidden="true">3.2.</strong> Event Handling</a></li><li class="chapter-item "><a href="../../concepts/the-elm-architecture.html"><strong aria-hidden="true">3.3.</strong> The Elm Architecture</a></li><li class="chapter-item "><a href="../../concepts/component-architecture.html"><strong aria-hidden="true">3.4.</strong> Component Architecture</a></li><li class="chapter-item "><div><strong aria-hidden="true">3.5.</strong> Project Structure</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.6.</strong> Application Patterns</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.7.</strong> Design Patterns</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.8.</strong> Application State</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.9.</strong> Event Handling</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.10.</strong> Key Binding</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.11.</strong> Threading</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.12.</strong> Logging</div></li><li class="chapter-item "><div><strong aria-hidden="true">3.13.</strong> Configuration</div></li></ol></li><li class="chapter-item expanded "><a href="../../integrations/index.html"><strong aria-hidden="true">4.</strong> Integrations</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> How To</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../how-to/features.html"><strong aria-hidden="true">5.1.</strong> Enable Features</a></li><li class="chapter-item "><a href="../../how-to/choose-a-backend.html"><strong aria-hidden="true">5.2.</strong> Choose a Backend</a></li><li class="chapter-item "><a href="../../how-to/setup-panic-hooks.html"><strong aria-hidden="true">5.3.</strong> Setup Panic Hooks</a></li><li class="chapter-item "><a href="../../how-to/setup-panic-hooks-better-panic.html"><strong aria-hidden="true">5.4.</strong> Setup Panic Hooks with better-panic</a></li><li class="chapter-item "><a href="../../how-to/setup-logging-tracing.html"><strong aria-hidden="true">5.5.</strong> Setup Logging with tracing</a></li><li class="chapter-item "><a href="../../how-to/handle-xdg-directories.html"><strong aria-hidden="true">5.6.</strong> Handle XDG Directories</a></li><li class="chapter-item "><a href="../../how-to/clap.html"><strong aria-hidden="true">5.7.</strong> Handle CLI arguments</a></li><li class="chapter-item "><a href="../../how-to/center-a-rect.html"><strong aria-hidden="true">5.8.</strong> Center a Rect</a></li><li class="chapter-item "><a href="../../how-to/combine-terminal-and-eventhandler.html"><strong aria-hidden="true">5.9.</strong> Combine Terminal and EventHandler</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.10.</strong> Blocks</div></li><li class="chapter-item "><div><strong aria-hidden="true">5.11.</strong> Displaying Text</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">5.11.1.</strong> Styling-Text</div></li><li class="chapter-item "><div><strong aria-hidden="true">5.11.2.</strong> Paragraphs</div></li></ol></li><li class="chapter-item "><a href="../../how-to/layout-constraints-basics.html"><strong aria-hidden="true">5.12.</strong> Layouts Constraints Basics</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.13.</strong> Layout Widgets</div></li><li class="chapter-item "><div><strong aria-hidden="true">5.14.</strong> Create a Widget</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> FAQ</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../faq/duplicate-key-events-windows.html"><strong aria-hidden="true">6.1.</strong> Duplicate key events on Windows</a></li><li class="chapter-item "><a href="../../faq/tokio-async.html"><strong aria-hidden="true">6.2.</strong> tokio / async</a></li><li class="chapter-item "><a href="../../faq/tui-rs-history.html"><strong aria-hidden="true">6.3.</strong> tui.rs history</a></li></ol></li><li class="chapter-item expanded "><a href="../../references/index.html"><strong aria-hidden="true">7.</strong> References</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Developer Guide</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../developer-guide/ratatui.html"><strong aria-hidden="true">8.1.</strong> Ratatui</a></li><li class="chapter-item "><a href="../../developer-guide/book.html"><strong aria-hidden="true">8.2.</strong> Ratatui Book</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ratatui Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/ratatui-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/ratatui-book/edit/main/src/tutorial/counter-async-app/async-event-stream.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="async-event-stream"><a class="header" href="#async-event-stream">Async Event Stream</a></h1>
<p>In it’s simplest form, most applications will have a <code>main</code> loop like this:</p>
<pre><code class="language-rust">fn main() -&gt; Result&lt;()&gt; {
  let mut app = App::new();

  let mut t = Tui::new()?;

  t.enter()?; // raw mode enabled

  loop {

    // get key event and update state
    // ... Special handling to read key or mouse events required here

    t.terminal.draw(|f| { // &lt;- `terminal.draw` is the only ratatui function here
      ui(app, f) // render state to terminal
    })?;

  }

  t.exit()?; // raw mode disabled

  Ok(())
}</code></pre>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note"></a></p>
</div>
<div>
<p>The <code>terminal.draw(|f| { ui(app, f); })</code> call is the only line in the code above that
uses <code>ratatui</code> functionality. You can learn more about
<a href="https://docs.rs/ratatui/latest/ratatui/terminal/struct.Terminal.html#method.draw"><code>draw</code> from the official documentation</a>.
Essentially, <code>terminal.draw()</code> takes a callback that takes a
<a href="https://docs.rs/ratatui/latest/ratatui/terminal/struct.Frame.html"><code>Frame</code></a> and
expects the callback to render widgets to that frame, which is then drawn to the terminal
using a double buffer technique.</p>
</div>
</div>
<p>While we are in the “raw mode”, i.e. after we call <code>t.enter()</code>, any key presses in that terminal
window are sent to <code>stdin</code>. We have to read these key presses from <code>stdin</code> if we want to act on
them.</p>
<p>There’s a number of different ways to do that. <code>crossterm</code> has a <code>event</code> module that implements
features to read these key presses for us.</p>
<p>Let’s assume we were building a simple “counter” application, that incremented a counter when we
pressed <code>j</code> and decremented a counter when we pressed <code>k</code>.</p>
<pre><code class="language-rust">fn main() -&gt; Result {
  let mut app = App::new();

  let mut t = Tui::new()?;

  t.enter()?;

  loop {
    if crossterm::event::poll(Duration::from_millis(250))? {
      if let Event::Key(key) = crossterm::event::read()? {
        match key.code {
          KeyCode::Char('j') =&gt; app.increment(),
          KeyCode::Char('k') =&gt; app.decrement(),
          KeyCode::Char('q') =&gt; break,
          _ =&gt; (),
        }
      }
    };

    t.terminal.draw(|f| {
      ui(app, f)
    })?;
  }

  t.exit()?;

  Ok(())
}</code></pre>
<p>This works perfectly fine, and a lot of small to medium size programs can get away with doing just
that.</p>
<p>However, this approach conflates the key input handling with app state updates, and does so in the
“draw” loop. The practical issue with this approach is we block the draw loop for 250 ms waiting for
a key press. This can have odd side effects, for example pressing an holding a key will result in
faster draws to the terminal.</p>
<p>In terms of architecture, the code could get complicated to reason about. For example, we may even
want key presses to mean <em>different</em> things depending on the state of the app (when you are focused
on an input field, you may want to enter the letter <code>&quot;j&quot;</code> into the text input field, but when
focused on a list of items, you may want to scroll down the list.)</p>
<p><img src="https://user-images.githubusercontent.com/1813121/254444604-de8cfcfa-eeec-417a-a8b0-92a7ccb5fcb5.gif" alt="Pressing j 3 times to increment counter and 3 times in the text field" /></p>
<!--
```
Set Shell zsh
Sleep 1s
Hide
Type "cargo run"
Enter
Sleep 1s
Show
Type "jjj"
Sleep 5s
Sleep 5s
Type "/jjj"
Sleep 5s
Escape
Type "q"
```
-->
<p>We have to do a few different things set ourselves up, so let’s take things one step at a time.</p>
<p>First, instead of polling, we are going to introduce channels to get the key presses asynchronously
and send them over a channel. We will then receive on the channel in the <code>main</code> loop.</p>
<p>There are two ways to do this. We can either use OS threads or “green” threads, i.e. tasks, i.e.
rust’s <code>async</code>-<code>await</code> features + a future executor.</p>
<p>Here’s example code of reading key presses asynchronously using <code>std::thread</code> and <code>tokio::task</code>.</p>
<h2 id="stdthread"><a class="header" href="#stdthread"><code>std::thread</code></a></h2>
<pre><code class="language-rust">enum Event {
  Key(crossterm::event::KeyEvent)
}

struct EventHandler {
  rx: std::sync::mpsc::Receiver&lt;Event&gt;,
}

impl EventHandler {
  fn new() -&gt; Self {
    let tick_rate = std::time::Duration::from_millis(250);
    let (tx, rx) =  std::sync::mpsc::channel();
    std::thread::spawn(move || {
      loop {
        if crossterm::event::poll(tick_rate)? {
          match crossterm::event::read()? {
            CrosstermEvent::Key(e) =&gt; tx.send(Event::Key(e)),
            _ =&gt; unimplemented!(),
          }?
        }
      }
    })

    EventHandler { rx }
  }

  fn next(&amp;self) -&gt; Result&lt;Event&gt; {
    Ok(self.rx.recv()?)
  }
}</code></pre>
<h2 id="tokiotask"><a class="header" href="#tokiotask"><code>tokio::task</code></a></h2>
<pre><code class="language-rust">enum Event {
  Key(crossterm::event::KeyEvent)
}

struct EventHandler {
  rx: tokio::sync::mpsc::UnboundedReceiver&lt;Event&gt;,
}

impl EventHandler {
  fn new() -&gt; Self {
    let tick_rate = std::time::Duration::from_millis(250);
    let (tx, mut rx) =  tokio::sync::mpsc::unbounded_channel();
    tokio::spawn(async move {
      loop {
        if crossterm::event::poll(tick_rate)? {
          match crossterm::event::read()? {
            CrosstermEvent::Key(e) =&gt; tx.send(Event::Key(e)),
            _ =&gt; unimplemented!(),
          }?
        }
      }
    })

    EventHandler { rx }
  }

  async fn next(&amp;self) -&gt; Result&lt;Event&gt; {
    Ok(self.rx.recv().await.ok()?)
  }
}</code></pre>
<h2 id="diff"><a class="header" href="#diff"><code>diff</code></a></h2>
<pre><code class="language-diff">  enum Event {
    Key(crossterm::event::KeyEvent)
  }

  struct EventHandler {
-   rx: std::sync::mpsc::Receiver&lt;Event&gt;,
+   rx: tokio::sync::mpsc::UnboundedReceiver&lt;Event&gt;,
  }

  impl EventHandler {
    fn new() -&gt; Self {
      let tick_rate = std::time::Duration::from_millis(250);
-     let (tx, rx) =  std::sync::mpsc::channel();
+     let (tx, mut rx) =  tokio::sync::mpsc::unbounded_channel();
-     std::thread::spawn(move || {
+     tokio::spawn(async move {
        loop {
          if crossterm::event::poll(tick_rate)? {
            match crossterm::event::read()? {
              CrosstermEvent::Key(e) =&gt; tx.send(Event::Key(e)),
              _ =&gt; unimplemented!(),
            }?
          }
        }
      })

      EventHandler { rx }
    }

-   fn next(&amp;self) -&gt; Result&lt;Event&gt; {
+   async fn next(&amp;self) -&gt; Result&lt;Event&gt; {
-     Ok(self.rx.recv()?)
+     Ok(self.rx.recv().await.ok()?)
    }
  }
</code></pre>
<div id="admonition-attention" class="admonition warning">
<div class="admonition-title">
<p>Attention</p>
<p><a class="admonition-anchor-link" href="#admonition-attention"></a></p>
</div>
<div>
<p>A lot of examples out there in the wild might use the following code for sending key presses:</p>
<pre><code class="language-rust">  CrosstermEvent::Key(e) =&gt; tx.send(Event::Key(e)),</code></pre>
<p>However, on Windows, when using <code>Crossterm</code>, this will send the same <code>Event::Key(e)</code> twice; one for when you press the key, i.e. <code>KeyEventKind::Press</code> and one for when you release the key, i.e. <code>KeyEventKind::Release</code>.
On <code>MacOS</code> and <code>Linux</code> only <code>KeyEventKind::Press</code> kinds of <code>key</code> event is generated.</p>
<p>To make the code work as expected across all platforms, you can do this instead:</p>
<pre><code class="language-rust">  CrosstermEvent::Key(key) =&gt; {
    if key.kind == KeyEventKind::Press {
      event_tx.send(Event::Key(key)).unwrap();
    }
  },</code></pre>
</div>
</div>
<p>Tokio is an asynchronous runtime for the Rust programming language. It is one of the more popular
runtimes for asynchronous programming in rust. You can learn more about here
<a href="https://tokio.rs/tokio/tutorial">https://tokio.rs/tokio/tutorial</a>. For the rest of the tutorial here, we are going to assume we want
to use tokio. I highly recommend you read the official <code>tokio</code> documentation.</p>
<p>If we use <code>tokio</code>, receiving a event requires <code>.await</code>. So our <code>main</code> loop now looks like this:</p>
<pre><code class="language-rust">#[tokio::main]
async fn main() -&gt; {
  let mut app = App::new();

  let events = EventHandler::new();

  let mut t = Tui::new()?;

  t.enter()?;

  loop {
    if let Event::Key(key) = events.next().await? {
      match key.code {
        KeyCode::Char('j') =&gt; app.increment(),
        KeyCode::Char('k') =&gt; app.decrement(),
        KeyCode::Char('q') =&gt; break,
        _ =&gt; (),
      }
    }

    t.terminal.draw(|f| {
      ui(app, f)
    })?;
  }

  t.exit()?;

  Ok(())
}</code></pre>
<h3 id="cancellationtoken"><a class="header" href="#cancellationtoken"><code>CancellationToken</code></a></h3>
<p>We want to use a <code>CancellationToken</code> to stop the tokio task on request.</p>
<p><a href="https://tokio.rs/tokio/tutorial/select"><code>tokio</code>’s <code>select!</code> macro</a> allows us to wait on multiple
<code>async</code> computations and returns when a single computation completes.</p>
<p>Here’s what the completed <code>EventHandler</code> code now looks like:</p>
<pre><code class="language-rust no_run noplayground">use anyhow::Result;
use crossterm::{
  cursor,
  event::{Event as CrosstermEvent, KeyEvent, KeyEventKind, MouseEvent},
};
use futures::{FutureExt, StreamExt};
use tokio::{
  sync::{mpsc, oneshot},
  task::JoinHandle,
};

#[derive(Clone, Copy, Debug)]
pub enum Event {
  Error,
  AppTick,
  Key(KeyEvent),
}

#[derive(Debug)]
pub struct EventHandler {
  _tx: mpsc::UnboundedSender&lt;Event&gt;,
  rx: mpsc::UnboundedReceiver&lt;Event&gt;,
  task: Option&lt;JoinHandle&lt;()&gt;&gt;,
  stop_cancellation_token: CancellationToken,
}

impl EventHandler {
  pub fn new(tick_rate: u64) -&gt; Self {
    let tick_rate = std::time::Duration::from_millis(tick_rate);

    let (tx, rx) = mpsc::unbounded_channel();
    let _tx = tx.clone();

    let stop_cancellation_token = CancellationToken::new();
    let _stop_cancellation_token = stop_cancellation_token.clone();

    let task = tokio::spawn(async move {
      let mut reader = crossterm::event::EventStream::new();
      let mut interval = tokio::time::interval(tick_rate);
      loop {
        let delay = interval.tick();
        let crossterm_event = reader.next().fuse();
        tokio::select! {
          _ = _stop_cancellation_token.cancelled() =&gt; {
            break;
          }
          maybe_event = crossterm_event =&gt; {
            match maybe_event {
              Some(Ok(evt)) =&gt; {
                match evt {
                  CrosstermEvent::Key(key) =&gt; {
                    if key.kind == KeyEventKind::Press {
                      tx.send(Event::Key(key)).unwrap();
                    }
                  },
                  _ =&gt; {},
                }
              }
              Some(Err(_)) =&gt; {
                tx.send(Event::Error).unwrap();
              }
              None =&gt; {},
            }
          },
          _ = delay =&gt; {
              tx.send(Event::AppTick).unwrap();
          },
        }
      }
    });

    Self { _tx, rx, task: Some(task), stop_cancellation_token }
  }

  pub async fn next(&amp;mut self) -&gt; Option&lt;Event&gt; {
    self.rx.recv().await
  }

  pub async fn stop(&amp;mut self) -&gt; Result&lt;()&gt; {
    self.stop_cancellation_token.cancel();
    if let Some(handle) = self.task.take() {
      handle.await.unwrap();
    }
    Ok(())
  }
}</code></pre>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note-1"></a></p>
</div>
<div>
<p>Using <code>crossterm::event::EventStream::new()</code> requires the <code>event-stream</code> feature to be enabled.</p>
<pre><code class="language-yml">crossterm = { version = &quot;0.27.0&quot;, features = [&quot;event-stream&quot;] }
</code></pre>
</div>
</div>
<p>With this <code>EventHandler</code> implemented, we can use <code>tokio</code> to create a separate “task” that handles
any key asynchronously in our <code>main</code> loop.</p>
<p>In the next section, we will introduce a <code>Command</code> pattern to bridge handling the effect of an
event.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../tutorial/counter-async-app/async-increment-decrement.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../concepts/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../tutorial/counter-async-app/async-increment-decrement.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../concepts/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
